<app-navbar [isSidebarOpen]="isSidebarOpen" [sidebarWidth]="220" [sidebarClosedWidth]="70"></app-navbar>
<div class="layout" [class.sidebar-closed]="!isSidebarOpen">
  <app-sidebar (toggle)="isSidebarOpen = $event"></app-sidebar>
  <main class="content">
    <!-- Breadcrumb Navigation -->
    <app-breadcrumb [items]="breadcrumbItems" [showBackButton]="true"></app-breadcrumb>
    
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <div class="header-icon">
          <i class="bi bi-boxes"></i>
        </div>
        <div>
          <h1 class="page-title">Dépôts</h1>
          <p class="page-subtitle">{{ filteredDepots.length }} dépôt(s) trouvé(s)</p>
        </div>
      </div>
      <button class="add-btn" (click)="openAddDialog()" [disabled]="!canAddData()" [title]="!canAddData() ? 'Ce projet n\'est pas actif' : 'Ajouter un nouveau dépôt'">
        <i class="bi bi-plus-lg"></i>
        <span>Ajouter un dépôt</span>
      </button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar-section">
      <div class="search-box">
        <i class="bi bi-search"></i>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Rechercher par nom..." 
          [(ngModel)]="depotFilter" 
          (input)="applyFilter()"
        />
      </div>
      <div class="toolbar-right">
        <span class="results-count">{{ filteredDepots.length }} résultat(s)</span>
        <div class="page-size-selector">
          <span>Afficher</span>
          <select [(ngModel)]="pageSize" (change)="onPageSizeChange()" class="page-size-select">
            <option *ngFor="let size of pageSizes" [value]="size">{{ size }}</option>
          </select>
          <span>lignes</span>
        </div>
      </div>
    </div>

    <!-- Date Filter Section -->
    <div class="date-filter-section">
      <div class="date-filter-card">
        <div class="date-filter-header">
          <div class="filter-title-group">
            <i class="bi bi-calendar-date"></i>
            <h4>Filtre par Date</h4>
          </div>
          <button 
            class="filter-toggle-btn"
            [class.active]="dateFilterActive"
            (click)="toggleDateFilter()">
            <i class="bi" [ngClass]="dateFilterActive ? 'bi-toggle-on' : 'bi-toggle-off'"></i>
            {{ dateFilterActive ? 'Actif' : 'Inactif' }}
          </button>
        </div>
        <div *ngIf="dateFilterActive" class="date-filter-body">
          <div class="filter-controls">
            <div class="date-input-group">
              <label>
                <i class="bi bi-calendar-event"></i>
                Date limite
              </label>
              <input 
                type="date" 
                [(ngModel)]="selectedDate"
                (change)="onDateFilterChange()"
                class="date-input"
              />
            </div>
            <div class="filter-actions">
              <button 
                class="clear-filter-btn"
                (click)="clearDateFilter()">
                <i class="bi bi-x-circle"></i>
                Effacer
              </button>
            </div>
          </div>
          <div *ngIf="selectedDate" class="filter-info-message">
            <i class="bi bi-info-circle-fill"></i>
            <span>Affichage des quantités vendues jusqu'au {{ formatDate(selectedDate) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table class="modern-table">
        <thead>
          <tr>
            <th class="sortable" (click)="sortBy('nom')">
              <div class="th-content">
                <span>Nom</span>
                <i class="bi" [ngClass]="{
                  'bi-chevron-down': sortColumn === 'nom' && sortDirection === 'desc',
                  'bi-chevron-up': sortColumn === 'nom' && sortDirection === 'asc',
                  'bi-chevron-expand': sortColumn !== 'nom'
                }"></i>
              </div>
            </th>
            <th class="text-center quantity-header">
              <div class="th-content">
                <i class="bi bi-box-seam-fill"></i>
                <span>Quantité Vendue</span>
              </div>
            </th>
            <th class="actions-header text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let dep of paginatedDepots" class="table-row">
            <td>
              <i class="bi bi-box-seam" style="margin-right: 8px; color: #6366f1;"></i>
              {{ dep.nom }}
            </td>
            <td class="text-center">
              <span class="quantity-badge">
                <i class="bi bi-box-seam-fill"></i>
                <span class="quantity-value">{{ getTotalLivreDepot(dep.id) | number:'1.0-2' }}</span>
                <span class="quantity-unit">kg</span>
              </span>
            </td>
            <td class="actions-cell">
              <button class="action-btn edit-btn" (click)="selectDepot(dep)" [disabled]="!canAddData()" [title]="!canAddData() ? 'Ce projet n\'est pas actif' : 'Modifier'">
                <i class="bi bi-pencil-fill"></i>
              </button>
              <button class="action-btn delete-btn" (click)="deleteDepot(dep.id)" [disabled]="!canAddData()" [title]="!canAddData() ? 'Ce projet n\'est pas actif' : 'Supprimer'">
                <i class="bi bi-trash-fill"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="paginatedDepots.length === 0" class="no-data-row">
            <td colspan="3">
              <div class="no-data">
                <i class="bi bi-inbox"></i>
                <p *ngIf="!isProjetActif()">Aucun dépôt trouvé</p>
                <p *ngIf="isProjetActif()">Aucun dépôt associé à ce projet</p>
                <p *ngIf="isProjetActif()" style="font-size: 13px; color: #64748b; margin-top: 8px;">
                  Ajoutez un nouveau dépôt pour ce projet
                </p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" *ngIf="filteredDepots.length > 0">
      <div class="pagination-info">
        Affichage de {{ (currentPage - 1) * pageSize + 1 }} à {{ Math.min(currentPage * pageSize, filteredDepots.length) }} sur {{ filteredDepots.length }} dépôt(s)
      </div>
      <div class="pagination-controls">
        <button class="page-btn" (click)="goToPage(1)" [disabled]="currentPage === 1">
          <i class="bi bi-chevron-double-left"></i>
        </button>
        <button class="page-btn" (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button 
          *ngFor="let page of getPageNumbers()" 
          class="page-btn" 
          [class.active]="page === currentPage"
          (click)="goToPage(page)"
        >
          {{ page }}
        </button>
        <button class="page-btn" (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">
          <i class="bi bi-chevron-right"></i>
        </button>
        <button class="page-btn" (click)="goToPage(totalPages)" [disabled]="currentPage === totalPages">
          <i class="bi bi-chevron-double-right"></i>
        </button>
      </div>
    </div>

    <!-- Dialog modal -->
    <div class="dialog-backdrop" *ngIf="showAddDialog || editMode" (click)="closeDialog()">
      <div class="dialog-modal" (click)="$event.stopPropagation()">
        <h3>{{ editMode ? 'Modifier le dépôt' : 'Ajouter un dépôt' }}</h3>
        
        <!-- Message d'information pour l'autocomplétion -->
        <div *ngIf="!editMode && selectedExistingDepot" style="background: #dbeafe; padding: 12px 16px; border-radius: 10px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
          <div style="display: flex; align-items: center; gap: 8px; color: #1e40af;">
            <i class="bi bi-info-circle-fill"></i>
            <span style="font-weight: 500;">Dépôt existant sélectionné : il sera associé à ce projet</span>
          </div>
        </div>
        
        <!-- Champ Nom avec autocomplétion -->
        <div style="position: relative; margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #475569; font-size: 13px;">
            <i class="bi bi-box-seam" style="margin-right: 6px;"></i>
            Nom du dépôt
          </label>
          <input 
            [(ngModel)]="dialogDepot.nom" 
            (input)="onDepotInputChange()"
            (blur)="closeSuggestions()"
            placeholder="Rechercher ou créer un dépôt..." 
            [disabled]="editMode"
            style="width: 100%;" 
          />
          
          <!-- Liste de suggestions -->
          <div *ngIf="showSuggestions && filteredSuggestions.length > 0" 
               style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-height: 250px; overflow-y: auto; z-index: 1000; margin-top: 4px;">
            <div *ngFor="let depot of filteredSuggestions" 
                 class="autocomplete-suggestion"
                 (mousedown)="selectSuggestion(depot)"
                 style="padding: 12px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f1f5f9; transition: background-color 0.2s;">
              <i class="bi bi-box-seam" style="color: #6366f1; font-size: 18px;"></i>
              <div class="suggestion-details" style="flex: 1;">
                <div class="suggestion-name" style="font-weight: 500; color: #1e293b;">{{ depot.nom }}</div>
              </div>
              <i class="bi bi-plus-circle suggestion-icon-return" style="color: #64748b; font-size: 16px;"></i>
            </div>
          </div>
        </div>
        
        <div class="dialog-actions">
          <button *ngIf="!editMode" (click)="addDialogDepot()" [disabled]="!canAddData()">
            <i class="bi" [ngClass]="selectedExistingDepot ? 'bi-link-45deg' : 'bi-plus-lg'"></i>
            {{ selectedExistingDepot ? 'Associer' : 'Créer' }}
          </button>
          <button *ngIf="editMode" (click)="updateDialogDepot()" [disabled]="!canAddData()">Enregistrer</button>
          <button (click)="closeDialog()">Annuler</button>
        </div>
      </div>
    </div>
  </main>
</div>
