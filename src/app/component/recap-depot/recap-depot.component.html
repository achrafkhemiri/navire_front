<app-navbar [isSidebarOpen]="isSidebarOpen" [sidebarWidth]="220" [sidebarClosedWidth]="70"></app-navbar>
<div class="layout" [class.sidebar-closed]="!isSidebarOpen">
  <app-sidebar (toggle)="isSidebarOpen = $event"></app-sidebar>
  <main class="content">
    <!-- Breadcrumb Navigation -->
    <app-breadcrumb [items]="breadcrumbItems" [showBackButton]="true"></app-breadcrumb>
    
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <div class="header-icon depot">
          <i class="bi bi-building"></i>
        </div>
        <div>
          <h1 class="page-title">Récapitulatif par Dépôt</h1>
          <p class="page-subtitle">Consultez l'historique détaillé des voyages par dépôt</p>
        </div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <div class="filter-card depot">
        <div class="filter-header depot">
          <i class="bi bi-funnel-fill"></i>
          <h3>Sélectionner un dépôt</h3>
        </div>
        <div class="filter-body">
          <div class="depot-search-container" style="position: relative;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1e293b; font-size: 14px;">
              <i class="bi bi-building-fill"></i> Dépôt
            </label>
            <input 
              [(ngModel)]="depotSearchInput" 
              (input)="onDepotSearchInput()"
              (focus)="onDepotSearchInput()"
              placeholder="Rechercher un dépôt par nom..." 
              class="search-input"
              autocomplete="off"
            />
            <div *ngIf="showDepotDropdown && filteredDepotsSearch.length > 0" 
                 (mousedown)="$event.preventDefault()"
                 class="dropdown-list">
              <div *ngFor="let dep of filteredDepotsSearch" 
                   (click)="selectDepot(dep)"
                   class="dropdown-item">
                <div class="depot-icon">
                  <i class="bi bi-building-fill-check"></i>
                </div>
                <div class="depot-info">
                  <div class="depot-name">{{ dep.nom }}</div>
                </div>
                <i class="bi bi-chevron-right"></i>
              </div>
            </div>
            <div *ngIf="showDepotDropdown && filteredDepotsSearch.length === 0 && depotSearchInput.trim()" 
                 class="dropdown-list empty">
              <i class="bi bi-search"></i> Aucun dépôt trouvé
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Depot Details & Table -->
    <div *ngIf="selectedDepot" class="recap-container">
      <!-- Depot Info Card -->
      <div class="depot-info-card">
        <div class="depot-header">
          <div class="depot-avatar">
            <i class="bi bi-building-fill"></i>
          </div>
          <div class="depot-details">
            <h2 class="depot-title">{{ selectedDepot.nom }}</h2>
            <div class="client-meta">
              <span class="meta-item">
                <i class="bi bi-box-seam"></i>
                Quantité autorisée: <strong>{{ getQuantiteAutorisee(selectedDepot.id) | number:'1.0-2' }} kg</strong>
              </span>
            </div>
          </div>
        </div>
        
        <!-- Statistics -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
              <i class="bi bi-truck"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">Total Voyages</div>
              <div class="stat-value">{{ filteredVoyages.length }}</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);">
              <i class="bi bi-box-seam"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">Total Livré</div>
              <div class="stat-value">{{ getTotalLivre() | number:'1.0-2' }} kg</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon" [style.background]="getResteGradient()">
              <i class="bi bi-bar-chart-fill"></i>
            </div>
            <div class="stat-info">
              <div class="stat-label">Reste</div>
              <div class="stat-value" [style.color]="getResteColor()">
                {{ getReste() | number:'1.0-2' }} kg
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Toolbar -->
      <div class="toolbar-section">
        <div class="toolbar-left">
          <div class="search-box">
            <i class="bi bi-search"></i>
            <input 
              type="text" 
              class="search-input" 
              placeholder="Rechercher par matricule, bon de livraison..." 
              [(ngModel)]="voyageFilter" 
              (input)="applyFilter()"
            />
          </div>
          <div class="date-filters">
            <div class="date-filter-item">
              <label>
                <i class="bi bi-calendar-range"></i> Date début
              </label>
              <input 
                type="date" 
                class="date-input" 
                [(ngModel)]="dateDebut" 
                (change)="applyFilter()"
              />
            </div>
            <div class="date-filter-item">
              <label>
                <i class="bi bi-calendar-check"></i> Date fin
              </label>
              <input 
                type="date" 
                class="date-input" 
                [(ngModel)]="dateFin" 
                (change)="applyFilter()"
              />
            </div>
          </div>
          <div *ngIf="dateDebut || dateFin" style="margin-top: 12px; padding: 12px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
            <i class="bi bi-info-circle-fill" style="color: #f59e0b; font-size: 16px; flex-shrink: 0;"></i>
            <div style="font-size: 13px; color: #92400e; line-height: 1.4;">
              <strong>Journée de travail :</strong> Les voyages incluent ceux effectués de <strong>7h00</strong> le matin jusqu'à <strong>6h00</strong> le lendemain
              <span *ngIf="dateDebut && dateFin">, du <strong>{{ dateDebut }}</strong> au <strong>{{ dateFin }}</strong></span>
              <span *ngIf="dateDebut && !dateFin">, à partir du <strong>{{ dateDebut }}</strong></span>
              <span *ngIf="!dateDebut && dateFin">, jusqu'au <strong>{{ dateFin }}</strong></span>
            </div>
          </div>
        </div>
        <div class="toolbar-right">
          <span class="results-count">
            <i class="bi bi-list-check"></i>
            {{ filteredVoyages.length }} voyage(s)
          </span>
          <button class="export-btn excel" (click)="exportToExcel()">
            <i class="bi bi-file-earmark-excel"></i>
            Excel
          </button>
          <button class="export-btn pdf" (click)="exportToPDF()">
            <i class="bi bi-file-earmark-pdf"></i>
            PDF
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-container">
        <table class="modern-table">
          <thead>
            <tr>
              <th (click)="sortBy('date')" class="sortable">
                <div class="th-content">
                  <span>Date</span>
                  <i class="bi" [ngClass]="{
                    'bi-chevron-down': sortColumn === 'date' && sortDirection === 'desc',
                    'bi-chevron-up': sortColumn === 'date' && sortDirection === 'asc',
                    'bi-chevron-expand': sortColumn !== 'date'
                  }"></i>
                </div>
              </th>
              <th>Bon de Livraison</th>
              <th>Ticket</th>
              <th (click)="sortBy('matricule')" class="sortable">
                <div class="th-content">
                  <span>Matricule Camion</span>
                  <i class="bi" [ngClass]="{
                    'bi-chevron-down': sortColumn === 'matricule' && sortDirection === 'desc',
                    'bi-chevron-up': sortColumn === 'matricule' && sortDirection === 'asc',
                    'bi-chevron-expand': sortColumn !== 'matricule'
                  }"></i>
                </div>
              </th>
              <th>Chauffeur</th>
              <th (click)="sortBy('poidsDepot')" class="sortable">
                <div class="th-content">
                  <span>Poids Voyage (kg)</span>
                  <i class="bi" [ngClass]="{
                    'bi-chevron-down': sortColumn === 'poidsDepot' && sortDirection === 'desc',
                    'bi-chevron-up': sortColumn === 'poidsDepot' && sortDirection === 'asc',
                    'bi-chevron-expand': sortColumn !== 'poidsDepot'
                  }"></i>
                </div>
              </th>
              <th (click)="sortBy('reste')" class="sortable">
                <div class="th-content">
                  <span>Reste (kg)</span>
                  <i class="bi" [ngClass]="{
                    'bi-chevron-down': sortColumn === 'reste' && sortDirection === 'desc',
                    'bi-chevron-up': sortColumn === 'reste' && sortDirection === 'asc',
                    'bi-chevron-expand': sortColumn !== 'reste'
                  }"></i>
                </div>
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let voyage of paginatedVoyages; let i = index" class="table-row">
              <td>
                <span class="date-badge">
                  <i class="bi bi-calendar-event"></i>
                  {{ voyage.date | date:'dd/MM/yyyy HH:mm' }}
                </span>
              </td>
              <td>{{ voyage.numBonLivraison }}</td>
              <td>{{ voyage.numTicket }}</td>
              <td>
                <span class="camion-badge">
                  <i class="bi bi-truck"></i>
                  {{ getCamionMatricule(voyage.camionId) }}
                </span>
              </td>
              <td>{{ getChauffeurNom(voyage.chauffeurId) }}</td>
              <td>
                <span class="poids-badge depot">
                  {{ voyage.poidsDepot | number:'1.0-2' }}
                </span>
              </td>
              <td>
                <span class="reste-badge" [ngClass]="{
                  'positive': getResteCumule(voyage, i) > 0,
                  'zero': getResteCumule(voyage, i) === 0,
                  'negative': getResteCumule(voyage, i) < 0
                }">
                  {{ getResteCumule(voyage, i) | number:'1.0-2' }}
                </span>
                <i *ngIf="getResteCumule(voyage, i) < 0" class="bi bi-exclamation-triangle text-danger ms-1" 
                   title="Dépassement détecté"></i>
              </td>
            </tr>
            <tr *ngIf="paginatedVoyages.length === 0" class="no-data-row">
              <td colspan="7">
                <div class="no-data">
                  <i class="bi bi-inbox"></i>
                  <p>Aucun voyage trouvé pour ce dépôt</p>
                </div>
              </td>
            </tr>
          </tbody>
          <tfoot *ngIf="paginatedVoyages.length > 0">
            <tr class="total-row">
              <td colspan="5" style="text-align: right; font-weight: 700; color: #1e293b;">
                <i class="bi bi-calculator"></i> TOTAL:
              </td>
              <td>
                <span class="total-badge depot">
                  {{ getTotalLivre() | number:'1.0-2' }} kg
                </span>
              </td>
              <td>
                <span class="total-badge" [style.color]="getResteColor()">
                  {{ getReste() | number:'1.0-2' }} kg
                </span>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination-container" *ngIf="filteredVoyages.length > 0">
        <div class="pagination-info">
          Affichage de {{ (currentPage - 1) * pageSize + 1 }} à {{ Math.min(currentPage * pageSize, filteredVoyages.length) }} sur {{ filteredVoyages.length }} voyage(s)
        </div>
        <div class="pagination-controls">
          <button class="page-btn" (click)="goToPage(1)" [disabled]="currentPage === 1">
            <i class="bi bi-chevron-double-left"></i>
          </button>
          <button class="page-btn" (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">
            <i class="bi bi-chevron-left"></i>
          </button>
          <span class="page-info">Page {{ currentPage }} / {{ totalPages }}</span>
          <button class="page-btn" (click)="goToPage(currentPage + 1)" [disabled]="currentPage === totalPages">
            <i class="bi bi-chevron-right"></i>
          </button>
          <button class="page-btn" (click)="goToPage(totalPages)" [disabled]="currentPage === totalPages">
            <i class="bi bi-chevron-double-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!selectedDepot" class="empty-state">
      <div class="empty-icon">
        <i class="bi bi-building-x"></i>
      </div>
      <h3>Aucun dépôt sélectionné</h3>
      <p>Veuillez sélectionner un dépôt pour voir le récapitulatif de ses voyages</p>
    </div>
  </main>
</div>
