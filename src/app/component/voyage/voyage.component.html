
<app-navbar [isSidebarOpen]="isSidebarOpen" [sidebarWidth]="220" [sidebarClosedWidth]="70"></app-navbar>
<div class="layout" [class.sidebar-closed]="!isSidebarOpen">
	<app-sidebar (toggle)="isSidebarOpen = $event"></app-sidebar>
	<main class="content">
		<h2 class="page-title">Voyages</h2>
		<section class="table-section">
			<div class="table-toolbar">
				<input class="table-filter" placeholder="Filtrer par bon livraison ou ticket" [(ngModel)]="voyageFilter" (input)="applyFilter()" />
				<button class="add-row-btn" (click)="openAddDialog()">
					<img src="assets/ajouter.png" alt="Ajouter" width="20" height="20" style="vertical-align:middle; margin-right:6px;" />
					Ajouter un voyage
				</button>
			</div>

			<div class="mat-elevation-z8">
				<table class="mat-mdc-table">
					<thead>
						<tr>
							<th class="mat-mdc-header-cell">Bon Livraison</th>
							<th class="mat-mdc-header-cell">Ticket</th>
							<th class="mat-mdc-header-cell">Reste</th>
							<th class="mat-mdc-header-cell">Date</th>
							<th class="mat-mdc-header-cell">Poids Client</th>
							<th class="mat-mdc-header-cell">Poids Dépôt</th>
							<th class="mat-mdc-header-cell">Chauffeur</th>
							<th class="mat-mdc-header-cell">Camion</th>
							<th class="mat-mdc-header-cell">Client</th>
							<th class="mat-mdc-header-cell">Dépôt</th>
							<th class="mat-mdc-header-cell">Projet</th>
							<th class="mat-mdc-header-cell">Actions</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let vg of filteredVoyages" class="mat-mdc-row">
							<td class="mat-mdc-cell">{{ vg.numBonLivraison }}</td>
							<td class="mat-mdc-cell">{{ vg.numTicket }}</td>
							<td class="mat-mdc-cell">{{ vg.reste }}</td>
							<td class="mat-mdc-cell">{{ vg.date }}</td>
							<td class="mat-mdc-cell">{{ vg.poidsClient }}</td>
							<td class="mat-mdc-cell">{{ vg.poidsDepot }}</td>
							<td class="mat-mdc-cell">{{ vg.chauffeurNom || vg.chauffeurId }}</td>
							<td class="mat-mdc-cell">{{ vg.camionNom || vg.camionId }}</td>
							<td class="mat-mdc-cell">{{ vg.clientNum || vg.clientId }}</td>
							<td class="mat-mdc-cell">{{ vg.depotNom || vg.depotId }}</td>
							<td class="mat-mdc-cell">{{ vg.projetId }}</td>
							<td class="mat-mdc-cell">
								<span class="actions-img-group">
									<img src="assets/edit.png" alt="Edit" width="24" height="24" style="cursor:pointer; margin-right:8px;" (click)="selectVoyage(vg)" />
									<img src="assets/delete.png" alt="Supprimer" width="24" height="24" style="cursor:pointer;" (click)="deleteVoyage(vg.id)" />
								</span>
							</td>
						</tr>
						<tr *ngIf="filteredVoyages.length === 0" class="mat-mdc-no-data-row">
							<td class="mat-mdc-cell" colspan="8">Aucun voyage trouvé.</td>
						</tr>
					</tbody>
				</table>
			</div>
		</section>

		<!-- Dialog modal pour ajout ou modification voyage -->
		<div class="dialog-backdrop" *ngIf="showAddDialog || editMode">
			<div class="dialog-modal" style="padding:18px 16px 12px 16px; min-width:280px; gap:10px;">
				<h3>{{ editMode ? 'Modifier le voyage' : 'Ajouter un voyage' }}</h3>
				<div *ngIf="error" class="dialog-error">{{ error }}</div>
				<label class="form-label">Bon Livraison</label>
				<input [(ngModel)]="dialogVoyage.numBonLivraison" placeholder="Bon Livraison" class="table-filter" style="margin-bottom:6px;" />
				<label class="form-label">Ticket</label>
				<input [(ngModel)]="dialogVoyage.numTicket" placeholder="Ticket" class="table-filter" style="margin-bottom:6px;" />
				<label class="form-label">Reste</label>
				<input [(ngModel)]="dialogVoyage.reste" type="number" placeholder="Reste" class="table-filter" style="margin-bottom:6px;" />
				<label class="form-label">Date</label>
				<input [(ngModel)]="dialogVoyage.date" placeholder="Date" class="table-filter" style="margin-bottom:6px;" />
				<div style="display:flex; gap:10px; margin-bottom:10px;">
						<button class="add-row-btn active-btn" [class.active-btn]="dialogVoyage._type === 'client'" (click)="dialogVoyage._type = 'client'; dialogVoyage.depotId = undefined; dialogVoyage.poidsDepot = undefined;">Client</button>
						<button class="add-row-btn active-btn" [class.active-btn]="dialogVoyage._type === 'depot'" (click)="dialogVoyage._type = 'depot'; dialogVoyage.clientId = undefined; dialogVoyage.poidsClient = undefined;">Dépôt</button>
				</div>
								<ng-container *ngIf="dialogVoyage._type === 'client'">
									<label class="form-label">Client</label>
									<select [(ngModel)]="dialogVoyage.clientId" class="table-filter" style="margin-bottom:6px;">
											<option [ngValue]="null">-- Client --</option>
											<option *ngFor="let cl of clients" [ngValue]="cl.id">{{ cl.nom }}</option>
									</select>
									<label *ngIf="dialogVoyage.clientId != null" class="form-label">Poids Client</label>
									<input *ngIf="dialogVoyage.clientId != null" [(ngModel)]="dialogVoyage.poidsClient" type="number" placeholder="Poids Client" class="table-filter" style="margin-bottom:6px;" />
								</ng-container>
								<ng-container *ngIf="dialogVoyage._type === 'depot'">
									<label class="form-label">Dépôt</label>
									<select [(ngModel)]="dialogVoyage.depotId" class="table-filter" style="margin-bottom:6px;">
											<option [ngValue]="null">-- Dépôt --</option>
											<option *ngFor="let dp of depots" [ngValue]="dp.id">{{ dp.nom }}</option>
									</select>
									<label *ngIf="dialogVoyage.depotId != null" class="form-label">Poids Dépôt</label>
									<input *ngIf="dialogVoyage.depotId != null" [(ngModel)]="dialogVoyage.poidsDepot" type="number" placeholder="Poids Dépôt" class="table-filter" style="margin-bottom:6px;" />
								</ng-container>
				<select [(ngModel)]="dialogVoyage.chauffeurId" class="table-filter" style="margin-bottom:6px;">
					<option [ngValue]="null">-- Chauffeur --</option>
					<option *ngFor="let ch of chauffeurs" [ngValue]="ch.id">{{ ch.nom }}</option>
				</select>
				<select [(ngModel)]="dialogVoyage.camionId" class="table-filter" style="margin-bottom:6px;">
					<option [ngValue]="null">-- Camion --</option>
					<option *ngFor="let ca of camions" [ngValue]="ca.id">{{ ca.matricule }}</option>
				</select>
				<select [(ngModel)]="dialogVoyage.projetId" class="table-filter" style="margin-bottom:6px;">
					<option [ngValue]="null">-- Projet --</option>
					<option *ngFor="let pr of projets" [ngValue]="pr.id">{{ pr.nom }}</option>
				</select>
				<input [(ngModel)]="dialogVoyage.userId" type="number" placeholder="User ID" class="table-filter" style="margin-bottom:6px;" />
				<div class="dialog-actions">
					<button class="add-row-btn" *ngIf="!editMode" (click)="addDialogVoyage()">Ajouter</button>
					<button class="add-row-btn" *ngIf="editMode" (click)="updateDialogVoyage()">Enregistrer</button>
					<button class="add-row-btn" (click)="closeDialog()">Annuler</button>
				</div>
			</div>
		</div>
	</main>
</div>
