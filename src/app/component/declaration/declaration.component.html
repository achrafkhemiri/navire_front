<div class="container-fluid mt-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h2><i class="bi bi-file-earmark-text"></i> Gestion des Déclarations</h2>
        <button class="btn btn-primary" (click)="openAddModal()" [disabled]="!selectedProjetId">
          <i class="bi bi-plus-circle"></i> Nouvelle Déclaration
        </button>
      </div>
    </div>
  </div>

  <!-- Project filter -->
  <div class="row mb-3">
    <div class="col-md-4">
      <label for="projetFilter" class="form-label">Filtrer par projet</label>
      <select 
        id="projetFilter" 
        class="form-select" 
        (change)="onProjetChange($event)"
        [value]="selectedProjetId || ''">
        <option value="">-- Sélectionner un projet --</option>
        <option *ngFor="let projet of projets" [value]="projet.id">
          {{ projet.societeNoms ? Array.from(projet.societeNoms).join(', ') : 'Aucune société' }}
        </option>
      </select>
    </div>
    <div class="col-md-8">
      <div class="alert alert-info mt-4" *ngIf="selectedProjetId">
        <i class="bi bi-info-circle"></i> 
        <strong>{{ declarations.length }}</strong> déclaration(s) trouvée(s) pour ce projet
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>Numéro de Déclaration</th>
                  <th>Quantité Manifestée</th>
                  <th>Projet</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngIf="declarations.length === 0">
                  <td colspan="5" class="text-center text-muted">
                    <i class="bi bi-inbox"></i> 
                    {{ selectedProjetId ? 'Aucune déclaration pour ce projet' : 'Veuillez sélectionner un projet' }}
                  </td>
                </tr>
                <tr *ngFor="let declaration of paginatedDeclarations; let i = index">
                  <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
                  <td>{{ declaration.numeroDeclaration }}</td>
                  <td>{{ declaration.quantiteManifestee | number:'1.2-2' }} T</td>
                  <td>
                    <span class="badge bg-secondary">{{ declaration.projetNom }}</span>
                  </td>
                  <td class="text-center">
                    <button 
                      class="btn btn-sm btn-outline-primary me-2" 
                      (click)="openEditModal(declaration)"
                      title="Modifier">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button 
                      class="btn btn-sm btn-outline-danger" 
                      (click)="openDeleteModal(declaration)"
                      title="Supprimer">
                      <i class="bi bi-trash"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <nav *ngIf="totalPages > 1" aria-label="Pagination">
            <ul class="pagination justify-content-center">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <a class="page-link" (click)="changePage(currentPage - 1)" aria-label="Précédent">
                  <span aria-hidden="true">&laquo;</span>
                </a>
              </li>
              <li class="page-item" *ngFor="let page of getPagesArray()" [class.active]="page === currentPage">
                <a class="page-link" (click)="changePage(page)">{{ page }}</a>
              </li>
              <li class="page-item" [class.disabled]="currentPage === totalPages">
                <a class="page-link" (click)="changePage(currentPage + 1)" aria-label="Suivant">
                  <span aria-hidden="true">&raquo;</span>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Modal -->
<div class="modal" [class.show]="showAddModal" [style.display]="showAddModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Nouvelle Déclaration</h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeAddModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="numeroDeclaration" class="form-label">Numéro de Déclaration <span class="text-danger">*</span></label>
            <input 
              type="text" 
              class="form-control" 
              id="numeroDeclaration" 
              [(ngModel)]="newDeclaration.numeroDeclaration"
              name="numeroDeclaration"
              placeholder="Ex: DEC-2024-001"
              required>
          </div>
          
          <div class="mb-3">
            <label for="quantiteManifestee" class="form-label">Quantité Manifestée (T) <span class="text-danger">*</span></label>
            <input 
              type="number" 
              class="form-control" 
              id="quantiteManifestee" 
              [(ngModel)]="newDeclaration.quantiteManifestee"
              name="quantiteManifestee"
              step="0.01"
              min="0"
              placeholder="Ex: 1500.50"
              required>
          </div>

          <div class="mb-3">
            <label class="form-label">Projet</label>
            <input 
              type="text" 
              class="form-control" 
              [value]="getProjetNom()"
              disabled>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeAddModal()">
          <i class="bi bi-x-circle"></i> Annuler
        </button>
        <button type="button" class="btn btn-primary" (click)="createDeclaration()">
          <i class="bi bi-save"></i> Enregistrer
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showAddModal" *ngIf="showAddModal"></div>

<!-- Edit Modal -->
<div class="modal" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title"><i class="bi bi-pencil"></i> Modifier la Déclaration</h5>
        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="editNumeroDeclaration" class="form-label">Numéro de Déclaration <span class="text-danger">*</span></label>
            <input 
              type="text" 
              class="form-control" 
              id="editNumeroDeclaration" 
              [(ngModel)]="editingDeclaration.numeroDeclaration"
              name="editNumeroDeclaration"
              required>
          </div>
          
          <div class="mb-3">
            <label for="editQuantiteManifestee" class="form-label">Quantité Manifestée (T) <span class="text-danger">*</span></label>
            <input 
              type="number" 
              class="form-control" 
              id="editQuantiteManifestee" 
              [(ngModel)]="editingDeclaration.quantiteManifestee"
              name="editQuantiteManifestee"
              step="0.01"
              min="0"
              required>
          </div>

          <div class="mb-3">
            <label class="form-label">Projet</label>
            <input 
              type="text" 
              class="form-control" 
              [value]="editingDeclaration.projetNom || ''"
              disabled>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
          <i class="bi bi-x-circle"></i> Annuler
        </button>
        <button type="button" class="btn btn-warning" (click)="updateDeclaration()">
          <i class="bi bi-save"></i> Mettre à jour
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showEditModal" *ngIf="showEditModal"></div>

<!-- Delete Confirmation Modal -->
<div class="modal" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirmer la Suppression</h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeDeleteModal()"></button>
      </div>
      <div class="modal-body">
        <p>Êtes-vous sûr de vouloir supprimer cette déclaration ?</p>
        <div class="alert alert-warning" *ngIf="declarationToDelete">
          <strong>Numéro:</strong> {{ declarationToDelete.numeroDeclaration }}<br>
          <strong>Quantité:</strong> {{ declarationToDelete.quantiteManifestee }} T
        </div>
        <p class="text-danger"><strong>Cette action est irréversible.</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">
          <i class="bi bi-x-circle"></i> Annuler
        </button>
        <button type="button" class="btn btn-danger" (click)="deleteDeclaration()">
          <i class="bi bi-trash"></i> Supprimer
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop fade" [class.show]="showDeleteModal" *ngIf="showDeleteModal"></div>
