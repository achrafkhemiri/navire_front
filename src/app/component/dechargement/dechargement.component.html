<app-navbar [isSidebarOpen]="isSidebarOpen" [sidebarWidth]="220" [sidebarClosedWidth]="70"></app-navbar>

<div class="layout" [class.sidebar-closed]="!isSidebarOpen">
  <app-sidebar (toggle)="isSidebarOpen = $event"></app-sidebar>

  <main class="content">
    <app-breadcrumb [items]="breadcrumbItems" [showBackButton]="true"></app-breadcrumb>

    <!-- Page Header -->
    <div class="page-header">
      <div class="page-header-content">
        <div class="page-icon">
          <i class="bi bi-box-arrow-down"></i>
        </div>
        <div class="page-title-section">
          <h1 class="page-title">Gestion des Déchargements</h1>
          <!-- Si un projet est actif, afficher ses détails même sans données -->
          <p class="page-subtitle badges-row" *ngIf="projetActif; else dechAggregates">
            <span class="info-badge" *ngIf="projetActif?.nomNavire">
              <i class="bi bi-truck-front"></i>
              <span class="badge-label">Navire</span>
              <span class="badge-value">{{ projetActif?.nomNavire }}</span>
            </span>
            <span class="info-badge" *ngIf="projetActif?.port">
              <i class="bi bi-geo-alt"></i>
              <span class="badge-label">Port</span>
              <span class="badge-value">{{ projetActif?.port }}</span>
            </span>
            <span class="info-badge" *ngIf="projetActif?.nomProduit">
              <i class="bi bi-box"></i>
              <span class="badge-label">Produit</span>
              <span class="badge-value">{{ projetActif?.nomProduit }}</span>
            </span>
            <span class="info-badge" *ngIf="societesList.length">
              <i class="bi bi-buildings"></i>
              <span class="badge-label">Sociétés</span>
              <span class="badge-value">{{ societesList.join(', ') }}</span>
            </span>
          </p>
          <!-- Sinon, fallback aux agrégats calculés -->
          <ng-template #dechAggregates>
            <p class="page-subtitle badges-row">
              <span class="info-badge" *ngIf="allNavires.length > 0"><i class="bi bi-truck-front"></i> <span class="badge-label">Navires</span> <span class="badge-value">{{ allNavires.join(', ') }}</span></span>
              <span class="info-badge" *ngIf="allPorts.length > 0"><i class="bi bi-geo-alt"></i> <span class="badge-label">Ports</span> <span class="badge-value">{{ allPorts.join(', ') }}</span></span>
              <span class="info-badge" *ngIf="allProduits.length > 0"><i class="bi bi-box"></i> <span class="badge-label">Produits</span> <span class="badge-value">{{ allProduits.join(', ') }}</span></span>
              <span class="info-badge" *ngIf="allProjets.length > 0"><i class="bi bi-folder"></i> <span class="badge-label">Projets</span> <span class="badge-value">{{ allProjets.join(', ') }}</span></span>
              <span *ngIf="allProduits.length === 0 && allProjets.length === 0 && allNavires.length === 0 && allPorts.length === 0">Consultation et suivi des déchargements effectués</span>
            </p>
          </ng-template>
        </div>
      </div>
      <div class="page-actions">
        <button class="action-button export-btn" (click)="exportToExcel()">
          <i class="bi bi-file-earmark-excel"></i>
          <span>Exporter</span>
        </button>
        <button class="action-button print-btn" (click)="printTable()">
          <i class="bi bi-printer"></i>
          <span>Imprimer</span>
        </button>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="error" class="error-message">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <span>{{ error }}</span>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
      <div class="filter-buttons">
        <button 
          class="filter-btn" 
          [class.active]="activeFilter === 'all'"
          (click)="setFilter('all')"
        >
          <i class="bi bi-grid-fill"></i>
          <span>Tous</span>
          <span class="badge">{{ allDechargementsCount }}</span>
        </button>
        <button 
          class="filter-btn" 
          [class.active]="activeFilter === 'date'"
          (click)="setFilter('date')"
        >
          <i class="bi bi-calendar-check"></i>
          <span>Par Date</span>
        </button>
        <button 
          class="filter-btn" 
          [class.active]="activeFilter === 'societe'"
          (click)="setFilter('societe')"
        >
          <i class="bi bi-building-fill"></i>
          <span>Par Transporteur</span>
        </button>
        <button 
          class="filter-btn" 
          [class.active]="activeFilter === 'projet'"
          (click)="setFilter('projet')"
        >
          <i class="bi bi-folder-fill"></i>
          <span>Par Projet</span>
        </button>
        <button 
          class="filter-btn" 
          [class.active]="activeFilter === 'produit'"
          (click)="setFilter('produit')"
        >
          <i class="bi bi-box-fill"></i>
          <span>Par Produit</span>
        </button>
      </div>

      <!-- Filter Details -->
      <div *ngIf="activeFilter === 'date'" class="filter-details">
        <div class="date-filter-card">
          <div class="date-input-group">
            <label class="date-filter-label">
              <i class="bi bi-calendar-event"></i>
              Sélectionner une date
            </label>
            <div class="date-row">
              <input 
                type="date" 
                [(ngModel)]="selectedDate" 
                (change)="applyFilter()"
                [max]="today"
                class="date-input"
              />
              <button class="clear-filter-btn" (click)="clearFilter('date')">
                <i class="bi bi-x-circle"></i>
                Effacer
              </button>
            </div>
          </div>
          <div class="filter-info-message">
            <i class="bi bi-info-circle-fill"></i>
            <span>
              <strong>Journée de travail :</strong> de <strong>7h00</strong> au jour sélectionné à <strong>6h00</strong> le lendemain
            </span>
          </div>
        </div>
      </div>

      <div *ngIf="activeFilter === 'societe'" class="filter-details">
        <label>
          <i class="bi bi-building-fill"></i> Sélectionner une société
        </label>
        <select 
          [(ngModel)]="selectedSociete" 
          (change)="applyFilter()">
          <option [ngValue]="null">-- Toutes les sociétés --</option>
          <option *ngFor="let societe of allSocietes" [ngValue]="societe">
            {{ societe }}
          </option>
        </select>
          <button class="btn btn-link" (click)="clearFilter('societe')">Effacer</button>
      </div>

      <div *ngIf="activeFilter === 'projet'" class="filter-details">
        <label>
          <i class="bi bi-folder-fill"></i> Sélectionner un projet
        </label>
        <select 
          [(ngModel)]="selectedProjet" 
          (change)="applyFilter()">
          <option [ngValue]="null">-- Tous les projets --</option>
          <option *ngFor="let projet of allProjets" [ngValue]="projet">
            {{ projet }}
          </option>
        </select>
          <button class="btn btn-link" (click)="clearFilter('projet')">Effacer</button>
      </div>

      <div *ngIf="activeFilter === 'produit'" class="filter-details">
        <label>
          <i class="bi bi-box-fill"></i> Sélectionner un produit
        </label>
        <select 
          [(ngModel)]="selectedProduit" 
          (change)="applyFilter()">
          <option [ngValue]="null">-- Tous les produits --</option>
          <option *ngFor="let produit of allProduits" [ngValue]="produit">
            {{ produit }}
          </option>
        </select>
          <button class="btn btn-link" (click)="clearFilter('produit')">Effacer</button>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar-section">
      <div class="search-box">
        <i class="bi bi-search"></i>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Rechercher par ticket, bon de livraison, client, dépôt..." 
          [(ngModel)]="searchFilter" 
          (input)="applyFilter()"
        />
      </div>
      <div class="toolbar-right">
        <span class="results-count">{{ filteredDechargements.length }} résultat(s)</span>
        <div class="page-size-selector">
          <span>Afficher</span>
          <select [(ngModel)]="pageSize" (change)="changePageSize()" class="page-size-select">
            <option *ngFor="let size of pageSizes" [value]="size">{{ size }}</option>
          </select>
          <span>lignes</span>
        </div>
      </div>
    </div>

    <!-- Table Container -->
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th (click)="sortBy('dateDechargement')" class="sortable date-column">
              <span class="th-content">
                Date Déchargement
                <i class="bi sort-icon" [ngClass]="{
                  'bi-chevron-down': sortColumn === 'dateDechargement' && sortDirection === 'desc',
                  'bi-chevron-up': sortColumn === 'dateDechargement' && sortDirection === 'asc',
                  'bi-chevron-expand': sortColumn !== 'dateDechargement'
                }"></i>
              </span>
            </th>
            <th (click)="sortBy('numTicket')" class="sortable">
              <span class="th-content">
                N° Ticket
                <i class="bi sort-icon" [ngClass]="{
                  'bi-chevron-down': sortColumn === 'numTicket' && sortDirection === 'desc',
                  'bi-chevron-up': sortColumn === 'numTicket' && sortDirection === 'asc',
                  'bi-chevron-expand': sortColumn !== 'numTicket'
                }"></i>
              </span>
            </th>
            <th>N° Bon<br>Livraison</th>
            <th>Transporteur</th>
            <th>Client</th>
            <th>Dépôt</th>
            <th>Poids Tar</th>
            <th>Poids Brut</th>
            <th>Poids Net</th>
            <th class="actions-column">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let dech of paginatedDechargements">
            <td class="date-cell">
              <div class="date-line">{{ formatDateOnly(dech.dateDechargement) }}</div>
              <div class="time-line">{{ formatTimeOnly(dech.dateDechargement) }}</div>
            </td>
            <td><span class="badge badge-info">{{ dech.numTicket }}</span></td>
            <td>{{ dech.numBonLivraison || '-' }}</td>
            <td>{{ dech.societe || '-' }}</td>
            <td>
              <span *ngIf="dech.clientId" class="badge badge-success">
                {{ getClientName(dech.clientId) }}
              </span>
              <span *ngIf="!dech.clientId">-</span>
            </td>
            <td>
              <span *ngIf="dech.depotId" class="badge badge-warning">
                {{ getDepotName(dech.depotId) }}
              </span>
              <span *ngIf="!dech.depotId">-</span>
            </td>
            <td>{{ dech.poidCamionVide?.toFixed(0) }}</td>
            <td>{{ dech.poidComplet?.toFixed(0) }}</td>
            <td>
              <strong style="color: #667eea;">
                {{ calculatePoidsNet(dech).toFixed(0) }}
              </strong>
            </td>
            <td class="actions-cell">
              <div class="action-buttons">
                <button class="action-btn edit-btn" (click)="editDechargement(dech)" title="Modifier">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button class="action-btn print-btn" (click)="printDechargement(dech)" title="Imprimer">
                  <i class="bi bi-printer"></i>
                </button>
                <button class="action-btn delete-btn" (click)="openDeleteDialog(dech)" title="Supprimer">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="paginatedDechargements.length === 0">
            <td colspan="9" style="text-align: center; padding: 40px; color: #94a3b8;">
              <i class="bi bi-inbox" style="font-size: 48px; display: block; margin-bottom: 16px;"></i>
              {{ searchFilter ? 'Aucun résultat trouvé' : 'Aucun déchargement enregistré' }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" *ngIf="filteredDechargements.length > 0">
      <div class="pagination-info">
        Affichage de {{ (currentPage - 1) * pageSize + 1 }} à {{ Math.min(currentPage * pageSize, filteredDechargements.length) }} sur {{ filteredDechargements.length }} entrées
      </div>
      <div class="pagination-controls">
        <button 
          class="page-btn" 
          (click)="goToPage(1)" 
          [disabled]="currentPage === 1"
          title="Première page">
          <i class="bi bi-chevron-double-left"></i>
        </button>
        <button 
          class="page-btn" 
          (click)="goToPage(currentPage - 1)" 
          [disabled]="currentPage === 1"
          title="Page précédente">
          <i class="bi bi-chevron-left"></i>
        </button>
        
        <button 
          *ngFor="let page of getPageNumbers()" 
          class="page-btn" 
          [class.active]="page === currentPage"
          (click)="goToPage(page)">
          {{ page }}
        </button>
        
        <button 
          class="page-btn" 
          (click)="goToPage(currentPage + 1)" 
          [disabled]="currentPage === totalPages"
          title="Page suivante">
          <i class="bi bi-chevron-right"></i>
        </button>
        <button 
          class="page-btn" 
          (click)="goToPage(totalPages)" 
          [disabled]="currentPage === totalPages"
          title="Dernière page">
          <i class="bi bi-chevron-double-right"></i>
        </button>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-backdrop" *ngIf="showDeleteDialog" (click)="closeDeleteDialog()"></div>
    <div class="modal-dialog" *ngIf="showDeleteDialog">
      <div class="modal-content">
        <div class="modal-header">
          <h3>
            <i class="bi bi-exclamation-triangle-fill" style="color: #dc2626;"></i>
            Confirmer la suppression
          </h3>
          <button class="close-btn" (click)="closeDeleteDialog()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="modal-body">
          <p>Êtes-vous sûr de vouloir supprimer ce déchargement ?</p>
          <div class="delete-info" *ngIf="dechargementToDelete">
            <div class="info-row">
              <strong>N° Ticket:</strong>
              <span>{{ dechargementToDelete.numTicket }}</span>
            </div>
            <div class="info-row" *ngIf="dechargementToDelete.clientId">
              <strong>Client:</strong>
              <span>{{ getClientName(dechargementToDelete.clientId) }}</span>
            </div>
            <div class="info-row" *ngIf="dechargementToDelete.depotId">
              <strong>Dépôt:</strong>
              <span>{{ getDepotName(dechargementToDelete.depotId) }}</span>
            </div>
            <div class="info-row">
              <strong>Poids Net:</strong>
              <span>{{ calculatePoidsNet(dechargementToDelete).toFixed(0) }}</span>
            </div>
          </div>
          <p style="color: #dc2626; margin-top: 16px;">
            <i class="bi bi-exclamation-circle"></i>
            Cette action est irréversible.
          </p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeDeleteDialog()">
            <i class="bi bi-x-circle"></i>
            Annuler
          </button>
          <button class="btn btn-danger" (click)="confirmDelete()">
            <i class="bi bi-trash"></i>
            Supprimer
          </button>
        </div>
      </div>
    </div>
  </main>
</div>
